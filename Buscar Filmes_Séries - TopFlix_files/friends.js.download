"use strict";var CurrentSec,friends=new function(){this.ScrollContainer=document.getElementById("ScrollContainer");var e,t=!1;let n,i=[],l=null,r=[],a=[];function o(){return config.pFlags&NamePowers.category}function d(e){addTitleBar(["mob1.friends","Friends"],"",null,e?t?["mob1.done","Done"]:["mob1.edit","Edit"]:"",e?friends.EditClick:null)}function s(e,t,n){if(!l||0==l.length||!o())return;let i=makeElement(document.getElementById("idfriends"),"li","section dropZone",t);n?(i.style.color=isColorLight(n)?"#000":"#FFF",i.style.backgroundColor=n):(i.style.color="#"+toHex6(config.ButColW),i.style.backgroundColor="#"+toHex6(config.ButCol));makeElement(document.getElementById("idfriends"),"ul","dropZone",e.replace(/ /g,"")+"_"+t);let a=makeElement(i,"span","section");addText(a,e),i.style.fontWeight=500,i.style.textAlign="center",r.push({id:t,name:e})}this.setSettings=function(e){var t,n,i;Settings=JSON.parse(e),l=Settings.categories.replace(/”/g,'"'),l=-1==l.indexOf('"')?JSON.parse(l.replace(/\?/g,'"')):JSON.parse(l),(null==(t=Settings)||null==(n=t.friendscategories)?void 0:n.replace(/”/g,'"').length)&&(a=Settings.friendscategories.replace(/”/g,'"')),(null==(i=a)?void 0:i.length)&&(a=JSON.parse(a.replace(/\?/g,'"')))},this.main=function(t){var n,i,l;xatMain(t),e=1&config.Flags,d(1),document.body.style.display="block",debug("fake"),e||(this.ScrollContainer.style.top=document.getElementById("titleBar").clientHeight+document.getElementById("topSelector").clientHeight+"px"),this.ScrollContainer.style.bottom="0px",this.ScrollContainer.addEventListener("scroll",onUsersScrollEventHandler,!1),doZap(10),TranslateAll(),document.querySelector(".friendSearchLabel")&&xrRoot.xrClassic||friends.initFriendSearch(),(null==(n=Settings)?void 0:n.friendscategories)&&(a=JSON.parse(null==(i=Settings)||null==(l=i.friendscategories)?void 0:l.replace(/”/g,'"')))},this.initFriendSearch=function(){if(xrRoot.xrClassic){let e=document.getElementById("visitorsContainer"),t=makeElement(null,"label","friendSearchLabel","",e);n=makeElement(t,"input","friendSearch","friendSearch"),n.setAttribute("autocomplete","off")}else{let e=document.querySelector("#searchBar");e&&(resizeSearchBar(e),n=e)}if(!n)return;let e=setTimeout((()=>{let t=document.querySelectorAll("li.friend");n.addEventListener("keyup",(e=>{friends.updateFriendsListResults(e,t)})),clearTimeout(e)}),5)},this.updateFriendsListResults=function(e,t){let n=e.target.value;if(t.length>0)for(let e=0;e<t.length;e++){let i=t[e].dataset,l=t[e].id.replace(/Friends/gi,""),r=t[e].getElementsByClassName("friendsName"),a=!1;r&&(r=r[0].innerText.toLowerCase().normalize("NFD").replace(/[^\x00-\x7F]/g,""),l.substr(0,n.length)==n&&(a=!0),r.indexOf(n.toLowerCase())>=0&&(a=!0),i&&i.regname&&i.regname.toLowerCase().indexOf(n.toLowerCase())>=0&&(a=!0),a?friends.hideShowIfNeeded(t[e],l,""):friends.hideShowIfNeeded(t[e],l,"none"))}},this.hideShowIfNeeded=function(e,t,n){if(e&&(e.style.display=n),t){let e=document.querySelector("#Friends"+t);e&&(e.style.display=n)}},this.setNoFriends=function(){var e=document.getElementById("idfriends");let t=document.querySelector(".friendSearchLabel");t&&(t.style.display="none"),e.appendChild(MakeHelpMessage(TransText("mob2.nofriends","No friends added")))},this.sendApp=function(e,n,i,l){var r;e.target;if(e&&e.stopPropagation(),null!==n&&"object"==typeof n)switch(n.Type){case"swiperight":if(!(l=n.id))return;n=l.substring(7);break;default:return}switch(n){case"Friends":t=!1;case"Contacts":(r={Page:"friends",Command:"friends"+n}).Type=r.Command,d("Friends"==n?1:0);break;default:if(0==n)return;if(!l)return r={Type:"Click",UserNo:n,Page:"friends",Command:"SaveId",Next:"actions"},void classicSetDialog(r.Next,n);r={UserNo:n,Page:"friends",Command:"Action",name:"Unfriend"}}ToC(r)},this.EditClick=function(){t=!t;var e={Command:"EditChange"};e.OnOff=t?"On":"Off",ToC(e),d(1)},this.SetEdit=function(e){var t,n=document.getElementsByClassName("EditCell"),i="1"==e;for(t=0;t<n.length;t++){var l=n[t];if(l.innerHTML="",i){var r=makeElement(l,"img");r.height=24,r.src="svg/deleteicon.svg",l.onclick=function(e){friends.sendApp(e,this.id.substring(3),0,"del")}}}},this.addSection=function(e){var t;t=clearDiv("idfriends"),makeElement(t,"div","","0");document.getElementById("idfriends");SetSection(e),l=JSON.parse(Settings.categories.replace(/”/g,'"')),l&&l.length>0&&o()&&(l.forEach((e=>{s(e.name,e.id,e.color)})),s("","others"))},this.addFriend=function(t,d){var s=JSON.parse(t);if(i.push(s),Settings&&("available"==Settings.hidefriends||"both"==Settings.hidefriends)&&"(p1pwn#ff5800)"==s.pawn)return;if(Settings&&("offline"==Settings.hidefriends||"both"==Settings.hidefriends)&&"(p1pwn#ff0000)"==s.pawn)return;var c=s.id;if(0==c)return;var m,u,g,f,p="",h=s.list,v=h+c,y=document.getElementById("idfriends");l&&l.length>0&&o()&&(y=document.getElementById("_others"),null==(f=a)||f.forEach((e=>{e.user==v&&(y=document.getElementById(e.name.replace(/ /g,"")+"_"+e.id))})));if(!y)return;removeById(v);var E,C=window,S=[],w=window,b=!1,k=!1,I=null,T=document.body,x=document.documentElement;let B=document.getElementById("visitorsContainer"),L=null,N=0;function F(e){var t=Math.max(0,C.pageXOffset||x.scrollLeft||T.scrollLeft||0)-(x.clientLeft||0);if(scrollY=Math.max(0,C.pageYOffset||x.scrollTop||T.scrollTop||0)-(x.clientTop||0),b)var n=void 0!==e&&void 0!==e.targetTouches?e.targetTouches[0]:{},i=n?Math.max(0,n.pageX||n.clientX||0)-t:0,l=n?Math.max(0,n.pageY||n.clientY||0)-scrollY:0;else i=e?Math.max(0,e.pageX||e.clientX||0)-t:0,l=e?Math.max(0,e.pageY||e.clientY||0)-scrollY:0;return{x:i,y:l}}function M(e,t,n){if(e){var i=e.getBoundingClientRect(),l=t>i.left&&t<i.left+i.width,r=n>i.top&&n<i.top+i.height;return l&&r}}function O(e,t){if(l&&l.length>0&&o()&&I){setTimeout((()=>k=!1),50),clearTimeout(E),I.style.top="0px",clearInterval(L),L=null,N=0,t.classList.remove("friendActive"),b?window.removeEventListener("touchmove",A):window.removeEventListener("mousemove",A);let n=null;l.forEach((e=>{n=document.getElementById(e.name.replace(/ /g,"")+"_"+e.id),n.style.backgroundColor="",n.style["border-radius"]=""})),n=document.getElementById("_others"),n.style.backgroundColor="",n.style["border-radius"]="",r.forEach((t=>{b=!1;F(e);var n=document.getElementById(t.id),i=document.getElementById(t.name.replace(/ /g,"")+"_"+t.id);if(M(n,S[0],S[1])||M(i,S[0],S[1])){var l,r;if(!I)return;let e=I.id,n=null==(l=a)?void 0:l.filter((t=>t.user==e));if(n&&void 0!==n[0]&&n[0].id==t.id||"others"==t.id&&!n[0])return;var o;if(document.getElementById(t.name.replace(/ /g,"")+"_"+t.id).appendChild(document.getElementById(e)),a=(null==(r=a)?void 0:r.filter((t=>t.user!=e)))||[],"others"!=t.id)null==(o=a)||o.push({user:e,name:t.name,id:t.id});console.log(a,t),function(e,t){let n={Page:"Setting",Command:"Setting",Name:e,Value:t};n.Type=n.Command,ToC(n)}("friendscategories",JSON.stringify(a))}})),I=null}B&&(B.style["overflow-y"]="auto")}function A(e){if(k&&I){let t=F(e);!function(e,t){if(!e)return;const n=B||e.parentNode;let i=n.getBoundingClientRect().height-Math.abs(Math.abs(e.getBoundingClientRect().top)-n.getBoundingClientRect().height),r=i>=n.getBoundingClientRect().height-15,a=i<=15;a||r?(n.style["overflow-y"]="auto",r?(clearInterval(L),L=null,L=setInterval((function(){n&&document.getElementById("idfriends")&&n.scrollTop<document.getElementById("idfriends").getBoundingClientRect().height-n.getBoundingClientRect().height&&(N+=10,n.scrollTop+=10),e.style.top=t+N+"px"}),25)):a&&(clearInterval(L),L=null,L=setInterval((function(){n.scrollTop>0&&(N-=10,n.scrollTop-=10),e.style.top=t+N+"px"}),25))):(n.style["overflow-y"]="hidden",clearInterval(L),L=null);let o=null;l.forEach((e=>{o=document.getElementById(e.name.replace(/ /g,"")+"_"+e.id),M(o,S[0],S[1])?(o.style["border-radius"]="4px",o.style.backgroundColor="rgba(30, 30, 130, 0.6)"):o&&(o.style.backgroundColor="",o.style["border-radius"]="")})),o=document.getElementById("_others"),M(o,S[0],S[1])?(o.style["border-radius"]=".3rem",o.style.backgroundColor="rgba(0, 0, 130, .2)"):o&&(o.style.backgroundColor="",o.style["border-radius"]=""),e.style.top=t+N+"px",e.style.position="relative"}(I,t.y-w.y),S=[t.x,t.y]}}var R,H,_,P=makeElement(null,"li","friend xfriend");iidLine++,P.setAttribute("data-line",iidLine),LineVisible=0,P.setAttribute("data-visible",LineVisible),P.id=v,P.setAttribute("data-regname",s.regname),AddHammer(P,Hammer.DIRECTION_RIGHT,this.sendApp),l&&l.length>0&&o()&&(P.addEventListener("mousedown",(function(e){clearInterval(L),I=this,b=!1,L=null,N=0,E=setTimeout((()=>{l&&l.length>0&&o()&&(window.addEventListener("mousemove",A,!1),this.classList.add("friendActive"),k=!0,w=F(e),A(e))}),250)}),!1),P.addEventListener("touchstart",(function(e){clearInterval(L),I=this,b=!0,L=null,N=0,E=setTimeout((()=>{l&&l.length>0&&o()&&(window.addEventListener("touchmove",A,!1),this.classList.add("friendActive"),k=!0,w=F(e),A(e))}),250)}),!1),window.addEventListener("touchend",(e=>{O(e,P)}),!1),window.addEventListener("mouseup",(e=>{O(e,P)}),!1),R=document,H="mouseout",_=e=>{var t=(e=e||window.event).relatedTarget||e.toElement;t&&"HTML"!=t.nodeName||O(e,P)},R.addEventListener?R.addEventListener(H,_,!1):R.attachEvent&&R.attachEvent("on"+H,_),P.addEventListener("touchcancel",O,!1));let J=getTooltipInfo(s);addToolTip(P,J,!1,"left",!0);var Y=makeElement(P,"div","listTable"),q=makeElement(Y,"div","dialogRow");makeElement(q,"div","dialogCell dialogCellMiddle EditCell","del"+c),e||(g=makeElement(q,"div","dialogCell dialogCellMiddle"));var D=makeElement(q,"div","dialogCell cellWide noPointer"),X=makeElement(D,"div","");makeElement(D,"div","");var U=makeElement(q,"div","dialogCell dialogCellMiddle");u=makeElement(U,"div","conimg","arw"+c),g&&(s.image||(s.image="(smile)"),LoadImage(g,s.image,"avatar",30,s)),(m=ProcessName(s.name,s.status,s.pFlags|NamePowers.nospace)).name.length>=35&&!e&&(m.name=m.name.substr(0,35)+".."),m.name=s.pawn+m.name,null!=m.status&&(p=m.status);var V=makeElement(X,"p");V.className="friendsName";var W=createSmText2(m,"message","holder pawnholder",20,268435456|s.pFlags);if(V.appendChild(W),!e){var Z=makeElement(X,"p");if(Z.className="friendsStatus",p){var z=document.createTextNode(p);void 0!==m.statusglow&&(Z.style["text-shadow"]=MakeGlow(m.statusglow)),void 0!==m.statuscol&&(Z.style.color="#"+toHex6(m.statuscol)),Z.appendChild(z)}var G=createSmText(s.text);Z.appendChild(G),u.innerHTML="";var j=makeElement(u,"img","conimg"),K=!1;switch(s.pawn){case"(p1pwn#00c100)":K="arrowgreen";break;case"(p1pwn#ff5800)":K="arroworange";break;case"(p1pwn#ff0000)":K="arrowred"}K&&(j.src="svg/"+K+".svg")}if(P.pid=[c,s.name],P.onclick=function(e){k||friends.sendApp(e,this.pid[0],this.pid[1])},d>=0){var Q=h+d;if(0==d){var $=y.firstChild;$?y.insertBefore(P,$):y.appendChild(P)}else insertAfter(P,document.getElementById(Q))}else y.appendChild(P);P.id=v,n&&n.value.length>0&&(P.style.display="none")}};